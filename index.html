<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rem√©dios ‚Äî Registro di√°rio</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b1220;
      --text:#eaf0ff;
      --muted:#9fb2d6;
      --accent:#5dd6ff;
      --ok:#33d17a;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --pill:999px;
      text-rendering: optimizeLegibility;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(93,214,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 100% 10%, rgba(51,209,122,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.72);
      border-bottom: 1px solid var(--border);
    }
    .wrap{max-width: 860px; margin:0 auto; padding: 14px 14px 26px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px 0;}
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h1{margin:0; font-size: 16px; letter-spacing:.2px;}
    .title .sub{font-size: 12px; color:var(--muted)}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 8px 10px;
      border-radius: var(--pill);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{border-color: rgba(93,214,255,.35)}
    .pill.primary{background: rgba(93,214,255,.14); border-color: rgba(93,214,255,.35)}
    .pill.danger{background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.35)}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 14px 0;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .kpi{
      flex:1 1 170px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .kpi .label{font-size: 12px; color:var(--muted)}
    .kpi .value{font-size: 18px; margin-top: 4px; font-weight: 700}
    .kpi .hint{font-size: 12px; color:var(--muted); margin-top: 2px}

    .medHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-top: 8px;
    }
    .medName{font-weight:800}
    .medMeta{font-size:12px; color:var(--muted); margin-top:2px}
    .medActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:none;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:650;
      color: var(--text);
      background: rgba(93,214,255,.14);
      border:1px solid rgba(93,214,255,.35);
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{background: rgba(255,255,255,.04); border-color: var(--border)}
    .btn.danger{background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.35)}
    .sep{height:1px; background: var(--border); margin: 12px 0}
    .small{font-size:12px; color:var(--muted)}

    .doseList{display:flex; flex-direction:column; gap:10px; margin-top: 10px}
    .dose{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      gap:10px;
    }
    .dose .left{display:flex; flex-direction:column; gap:2px}
    .dose .name{font-weight: 650}
    .dose .meta{font-size: 12px; color:var(--muted)}
    .dose .right{display:flex; align-items:center; gap:10px}
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: var(--pill);
      border:1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .tag.ok{color: rgba(51,209,122,.95); border-color: rgba(51,209,122,.35); background: rgba(51,209,122,.10)}

    .histHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
    .histHead h2{margin:0; font-size:14px}
    .day{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.02);
      margin-bottom: 10px;
    }
    .day .dtitle{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .day .dtitle .date{font-weight:800}
    .day .dtitle .sum{font-size:12px; color:var(--muted)}
    .times{margin-top: 8px; display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:12px;
      padding: 6px 10px;
      border-radius: var(--pill);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
    }
    .chip.muted{color: var(--muted)}

    dialog{
      border:none;
      border-radius: 18px;
      padding: 0;
      width: min(680px, calc(100vw - 24px));
      box-shadow: var(--shadow);
      background: #0b1220;
      color: var(--text);
    }
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .modal{border:1px solid var(--border); border-radius: 18px; overflow:hidden;}
    .modal header{background: rgba(255,255,255,.03); border-bottom: 1px solid var(--border); padding: 12px 14px;}
    .modal header h3{margin:0; font-size: 14px}
    .modal .content{padding: 14px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom: 10px}
    label{font-size:12px; color:var(--muted)}
    input, textarea{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      color: var(--text);
      outline: none;
    }
    textarea{min-height: 72px; resize: vertical}
    .actions{display:flex; gap:10px; justify-content:flex-end; padding-top: 6px}
    .warnbox{
      border:1px solid rgba(93,214,255,.35);
      background: rgba(93,214,255,.10);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      color: var(--text);
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Rem√©dios ‚Äî Registro di√°rio</h1>
        <div class="sub">Sem alarmes. S√≥ marcar e checar.</div>
      </div>
      <div class="pillrow">
        <button class="pill primary" id="btnRefresh">üîÑ Atualizar</button>
        <button class="pill primary" id="btnAddMed">‚ûï Rem√©dio</button>
        <button class="pill primary" id="btnBackup">üì§ Backup</button>
        <button class="pill primary" id="btnRestore">üì• Restaurar</button>
        <button class="pill danger" id="btnResetToday">‚Ü©Ô∏è Zerar hoje</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <div class="kpi">
        <div class="label">Hoje</div>
        <div class="value" id="todayLabel">‚Äî</div>
        <div class="hint" id="todayHint">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">Progresso do dia</div>
        <div class="value" id="kpiTaken">0/0</div>
        <div class="hint">Total de doses marcadas</div>
      </div>
      <div class="kpi">
        <div class="label">√öltima marca√ß√£o</div>
        <div class="value" id="kpiLast">‚Äî</div>
        <div class="hint">Hora registrada automaticamente</div>
      </div>
    </div>
    <div class="sep"></div>
    <div class="small">Dica: marcou na hora que tomou ‚Üí voc√™ nunca mais fica na d√∫vida ‚Äútomei ou n√£o‚Äù.</div>
  </section>

  <section id="todayMeds"></section>

  <section class="card">
    <div class="histHead">
      <h2>Hist√≥rico (√∫ltimos 30 dias)</h2>
      <button class="btn secondary" id="btnClearHistory">Limpar hist√≥rico</button>
    </div>
    <div id="history"></div>
    <div class="small">Os dados ficam no seu aparelho. Backup/Restaurar serve para trocar de celular sem perder tudo.</div>
  </section>
</main>

<!-- Modal: Add/Edit Med -->
<dialog id="dlgMed">
  <div class="modal">
    <header><h3 id="dlgMedTitle">Novo rem√©dio</h3></header>
    <div class="content">
      <div class="warnbox">Aqui √© s√≥ registro/organiza√ß√£o. N√£o √© orienta√ß√£o m√©dica.</div>
      <div class="sep"></div>

      <div class="field">
        <label>Nome do rem√©dio</label>
        <input id="medName" type="text" placeholder="Ex.: Glifage" />
      </div>
      <div class="field">
        <label>Quantas doses por dia?</label>
        <input id="medPerDay" type="number" min="1" max="12" value="1" />
      </div>
      <div class="field">
        <label>Observa√ß√£o (opcional)</label>
        <textarea id="medNotes" placeholder="Ex.: tomar com comida / evitar √† noite etc."></textarea>
      </div>

      <div class="actions">
        <button class="btn secondary" id="btnCancelMed">Cancelar</button>
        <button class="btn" id="btnSaveMed">Salvar</button>
      </div>
    </div>
  </div>
</dialog>

<!-- Modal: Restore -->
<dialog id="dlgRestore">
  <div class="modal">
    <header><h3>Restaurar backup</h3></header>
    <div class="content">
      <div class="field">
        <label>Cole aqui o JSON do backup</label>
        <textarea id="restoreText" placeholder='{"exportedAt":"...","data":{...}}'></textarea>
      </div>
      <div class="actions">
        <button class="btn secondary" id="btnCancelRestore">Cancelar</button>
        <button class="btn" id="btnDoRestore">Restaurar</button>
      </div>
      <div class="small">Se colar um backup v√°lido, ele substitui os dados atuais.</div>
    </div>
  </div>
</dialog>

<script>
/* =========================
   PWA: registrar Service Worker
========================= */
(function registerSW(){
  if (!("serviceWorker" in navigator)) return;
  window.addEventListener("load", async () => {
    try{
      await navigator.serviceWorker.register("./sw.js", { scope: "./" });
    }catch(e){
      console.warn("SW n√£o registrado:", e);
    }
  });
})();

/* =========================
   Estado
========================= */
const STORAGE_KEY = "remedios_registro_v2";

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function pad2(n){ return String(n).padStart(2,"0"); }
function fmtDateKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function fmtHumanDate(d){
  const wd = d.toLocaleDateString("pt-BR",{weekday:"short"});
  const dt = d.toLocaleDateString("pt-BR",{day:"2-digit",month:"short",year:"numeric"});
  return `${wd.replace(".","")}, ${dt}`;
}
function fmtTime(d){ return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }

function defaultState(){
  return {
    meds: [
      // exemplo inicial (pode apagar depois)
      { id: uid(), name: "Glifage (exemplo)", perDay: 3, notes: "" }
    ],
    // days[YYYY-MM-DD].taken = [{medId, doseIndex, at}]
    days: {}
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const st = JSON.parse(raw);
    // migra√ß√£o leve se faltar algo
    return {
      meds: Array.isArray(st.meds) && st.meds.length ? st.meds : defaultState().meds,
      days: st.days || {}
    };
  }catch(e){
    return defaultState();
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

let state = loadState();

function ensureToday(){
  const key = fmtDateKey(new Date());
  if(!state.days[key]) state.days[key] = { taken: [] };
  return key;
}
function takenForDay(dayKey){
  return state.days[dayKey]?.taken || [];
}
function isDoseTaken(dayKey, medId, doseIndex){
  return takenForDay(dayKey).some(x => x.medId===medId && x.doseIndex===doseIndex);
}
function getDoseRecord(dayKey, medId, doseIndex){
  return takenForDay(dayKey).find(x => x.medId===medId && x.doseIndex===doseIndex) || null;
}

/* =========================
   Elementos
========================= */
const elTodayLabel = document.getElementById("todayLabel");
const elTodayHint  = document.getElementById("todayHint");
const elKpiTaken   = document.getElementById("kpiTaken");
const elKpiLast    = document.getElementById("kpiLast");
const elTodayMeds  = document.getElementById("todayMeds");
const elHistory    = document.getElementById("history");

const btnRefresh = document.getElementById("btnRefresh");
const btnAddMed = document.getElementById("btnAddMed");
const btnBackup = document.getElementById("btnBackup");
const btnRestore = document.getElementById("btnRestore");
const btnResetToday = document.getElementById("btnResetToday");
const btnClearHistory = document.getElementById("btnClearHistory");

const dlgMed = document.getElementById("dlgMed");
const dlgMedTitle = document.getElementById("dlgMedTitle");
const medName = document.getElementById("medName");
const medPerDay = document.getElementById("medPerDay");
const medNotes = document.getElementById("medNotes");
const btnCancelMed = document.getElementById("btnCancelMed");
const btnSaveMed = document.getElementById("btnSaveMed");

const dlgRestore = document.getElementById("dlgRestore");
const restoreText = document.getElementById("restoreText");
const btnCancelRestore = document.getElementById("btnCancelRestore");
const btnDoRestore = document.getElementById("btnDoRestore");

let editingMedId = null;

/* =========================
   Render
========================= */
function render(){
  const now = new Date();
  const dayKey = ensureToday();

  elTodayLabel.textContent = fmtHumanDate(now);
  elTodayHint.textContent = `${state.meds.length} rem√©dio(s) ‚Ä¢ registro do dia`;

  // KPIs
  const totalPlanned = state.meds.reduce((acc,m)=>acc + (m.perDay||0), 0);
  const taken = takenForDay(dayKey);
  const totalTaken = taken.length;
  elKpiTaken.textContent = `${totalTaken}/${totalPlanned}`;

  let last = "‚Äî";
  if(taken.length){
    const lastRec = taken.slice().sort((a,b)=>(a.at||"").localeCompare(b.at||"")).at(-1);
    if(lastRec?.at) last = lastRec.at;
  }
  elKpiLast.textContent = last;

  // Hoje: cards por rem√©dio
  elTodayMeds.innerHTML = "";
  if(!state.meds.length){
    elTodayMeds.innerHTML = `<section class="card"><div class="small">Nenhum rem√©dio cadastrado. Toque em <b>‚ûï Rem√©dio</b>.</div></section>`;
  }else{
    state.meds.forEach(med=>{
      elTodayMeds.appendChild(renderMedCard(dayKey, med));
    });
  }

  renderHistory();
}

function renderMedCard(dayKey, med){
  const card = document.createElement("section");
  card.className = "card";

  const head = document.createElement("div");
  head.className = "medHead";

  const left = document.createElement("div");
  left.innerHTML = `
    <div class="medName">${escapeHtml(med.name)}</div>
    <div class="medMeta">${(med.perDay||0)} dose(s)/dia${med.notes ? " ‚Ä¢ " + escapeHtml(med.notes) : ""}</div>
  `;

  const actions = document.createElement("div");
  actions.className = "medActions";

  const btnEdit = document.createElement("button");
  btnEdit.className = "btn secondary";
  btnEdit.textContent = "Editar";
  btnEdit.addEventListener("click", ()=> openEditMed(med.id));

  const btnDel = document.createElement("button");
  btnDel.className = "btn danger";
  btnDel.textContent = "Excluir";
  btnDel.addEventListener("click", ()=> deleteMed(med.id));

  actions.appendChild(btnEdit);
  actions.appendChild(btnDel);

  head.appendChild(left);
  head.appendChild(actions);

  card.appendChild(head);
  card.appendChild(divSep());

  const list = document.createElement("div");
  list.className = "doseList";

  const per = clampInt(med.perDay, 1, 12);
  for(let i=1;i<=per;i++){
    list.appendChild(renderDoseRow(dayKey, med, i));
  }
  card.appendChild(list);

  return card;
}

function renderDoseRow(dayKey, med, doseIndex){
  const isTaken = isDoseTaken(dayKey, med.id, doseIndex);
  const rec = getDoseRecord(dayKey, med.id, doseIndex);
  const at = rec?.at ? `Marcado √†s ${rec.at}` : "N√£o marcado";

  const row = document.createElement("div");
  row.className = "dose";

  const left = document.createElement("div");
  left.className = "left";
  left.innerHTML = `
    <div class="name">${escapeHtml(med.name)} ‚Äî dose ${doseIndex}</div>
    <div class="meta">${at}</div>
  `;

  const right = document.createElement("div");
  right.className = "right";

  const tag = document.createElement("div");
  tag.className = "tag " + (isTaken ? "ok" : "");
  tag.textContent = isTaken ? "‚úÖ Tomado" : "‚¨ú Pendente";

  const btn = document.createElement("button");
  btn.className = "btn " + (isTaken ? "secondary" : "");
  btn.textContent = isTaken ? "Desmarcar" : "Marcar como tomado";
  btn.addEventListener("click", ()=> toggleDose(dayKey, med.id, doseIndex));

  right.appendChild(tag);
  right.appendChild(btn);

  row.appendChild(left);
  row.appendChild(right);
  return row;
}

function divSep(){
  const s = document.createElement("div");
  s.className = "sep";
  return s;
}

/* =========================
   A√ß√µes: marcar / desmarcar
========================= */
function toggleDose(dayKey, medId, doseIndex){
  const day = state.days[dayKey] || { taken: [] };
  const idx = day.taken.findIndex(x => x.medId===medId && x.doseIndex===doseIndex);

  if(idx>=0){
    day.taken.splice(idx,1);
  }else{
    day.taken.push({ medId, doseIndex, at: fmtTime(new Date()) });
  }
  state.days[dayKey] = day;
  saveState();
  render();
}

/* =========================
   CRUD de rem√©dios
========================= */
function openNewMed(){
  editingMedId = null;
  dlgMedTitle.textContent = "Novo rem√©dio";
  medName.value = "";
  medPerDay.value = 1;
  medNotes.value = "";
  dlgMed.showModal();
}
function openEditMed(id){
  const med = state.meds.find(m=>m.id===id);
  if(!med) return;
  editingMedId = id;
  dlgMedTitle.textContent = "Editar rem√©dio";
  medName.value = med.name || "";
  medPerDay.value = clampInt(med.perDay, 1, 12);
  medNotes.value = med.notes || "";
  dlgMed.showModal();
}
function saveMed(){
  const name = (medName.value || "").trim();
  const perDay = clampInt(parseInt(medPerDay.value,10), 1, 12);
  const notes = (medNotes.value || "").trim();

  if(!name){
    alert("Digite o nome do rem√©dio.");
    return;
  }

  if(editingMedId){
    const med = state.meds.find(m=>m.id===editingMedId);
    if(!med) return;
    med.name = name;
    med.perDay = perDay;
    med.notes = notes;

    // se reduziu perDay, remover doses acima do limite no dia/hist√≥rico
    Object.keys(state.days).forEach(k=>{
      const day = state.days[k];
      if(!day?.taken) return;
      day.taken = day.taken.filter(x => !(x.medId===editingMedId && x.doseIndex>perDay));
    });

  }else{
    state.meds.push({ id: uid(), name, perDay, notes });
  }

  saveState();
  dlgMed.close();
  render();
}
function deleteMed(id){
  const med = state.meds.find(m=>m.id===id);
  if(!med) return;
  if(!confirm(`Excluir "${med.name}"? Isso remove tamb√©m as marca√ß√µes desse rem√©dio no hist√≥rico.`)) return;

  state.meds = state.meds.filter(m=>m.id!==id);
  Object.keys(state.days).forEach(k=>{
    const day = state.days[k];
    if(!day?.taken) return;
    day.taken = day.taken.filter(x=>x.medId!==id);
  });

  saveState();
  render();
}

/* =========================
   Hist√≥rico (√∫ltimos 30 dias)
========================= */
function renderHistory(){
  const keys = Object.keys(state.days).sort().reverse();
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
  const cutoffKey = fmtDateKey(cutoff);
  const recent = keys.filter(k => k >= cutoffKey);

  if(!recent.length){
    elHistory.innerHTML = `<div class="small">Sem hist√≥rico ainda. Suas marca√ß√µes aparecer√£o aqui.</div>`;
    return;
  }

  elHistory.innerHTML = "";
  recent.forEach(k=>{
    const day = state.days[k] || { taken: [] };
    const planned = state.meds.reduce((acc,m)=>acc + (m.perDay||0), 0);
    const done = (day.taken||[]).length;

    const d = new Date(k+"T12:00:00");
    const wrap = document.createElement("div");
    wrap.className = "day";

    const top = document.createElement("div");
    top.className = "dtitle";
    top.innerHTML = `
      <div class="date">${d.toLocaleDateString("pt-BR")}</div>
      <div class="sum">${done}/${planned} dose(s) marcada(s)</div>
    `;

    const times = document.createElement("div");
    times.className = "times";

    if(!day.taken?.length){
      const ch = document.createElement("div");
      ch.className = "chip muted";
      ch.textContent = "sem marca√ß√µes";
      times.appendChild(ch);
    }else{
      const ordered = day.taken.slice().sort((a,b)=> (a.at||"").localeCompare(b.at||""));
      ordered.forEach(x=>{
        const med = state.meds.find(m=>m.id===x.medId);
        const medLabel = med ? med.name : "Rem√©dio removido";
        const ch = document.createElement("div");
        ch.className = "chip";
        ch.textContent = `${medLabel} ‚Ä¢ dose ${x.doseIndex} ‚Ä¢ ${x.at || "‚Äî"}`;
        times.appendChild(ch);
      });
    }

    wrap.appendChild(top);
    wrap.appendChild(times);
    elHistory.appendChild(wrap);
  });
}

/* =========================
   Backup / Restore
========================= */
function downloadText(filename, text){
  const blob = new Blob([text], {type:"application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

btnBackup.addEventListener("click", ()=>{
  const payload = { exportedAt: new Date().toISOString(), app:"remedios-registro", version:2, data: state };
  downloadText(`backup_remedios_${fmtDateKey(new Date())}.json`, JSON.stringify(payload, null, 2));
});

btnRestore.addEventListener("click", ()=>{
  restoreText.value = "";
  dlgRestore.showModal();
});
btnCancelRestore.addEventListener("click", ()=> dlgRestore.close());
btnDoRestore.addEventListener("click", ()=>{
  try{
    const obj = JSON.parse(restoreText.value.trim());
    const data = obj.data || obj;
    if(!data.meds || !data.days) throw new Error("Backup inv√°lido (faltam campos).");
    state = { meds: data.meds, days: data.days };
    saveState();
    dlgRestore.close();
    render();
    alert("Backup restaurado com sucesso.");
  }catch(e){
    alert("N√£o consegui restaurar. Verifique o JSON.\n\n" + e.message);
  }
});

/* =========================
   Bot√µes gerais
========================= */
btnRefresh.addEventListener("click", ()=>{
  // bot√£o ‚ÄúAtualizar‚Äù: recarrega do storage e redesenha
  state = loadState();
  render();
});

btnAddMed.addEventListener("click", openNewMed);
btnCancelMed.addEventListener("click", ()=> dlgMed.close());
btnSaveMed.addEventListener("click", saveMed);

btnResetToday.addEventListener("click", ()=>{
  if(!confirm("Zerar as marca√ß√µes de HOJE (para todos os rem√©dios)?")) return;
  state.days[fmtDateKey(new Date())] = { taken: [] };
  saveState();
  render();
});

btnClearHistory.addEventListener("click", ()=>{
  if(!confirm("Apagar TODO o hist√≥rico? (os rem√©dios cadastrados ficam)")) return;
  state.days = {};
  saveState();
  render();
});

/* =========================
   Utils
========================= */
function clampInt(n, min, max){
  n = Number.isFinite(n) ? n : min;
  return Math.max(min, Math.min(max, n));
}
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* init */
render();
</script>
</body>
</html>
